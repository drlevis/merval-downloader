#!/usr/bin/env python3\n\"\"\"\nScript COMPLETO para descargar datos MERVAL desde Yahoo Finance\n\nTICKERS CONFIRMADOS FUNCIONANDO:\n‚úÖ GGAL, BMA, LOMA, CEPU, EDN, SUPV, BBAR, AGRO, YPFD, PAMP, ALUA\n\nFIX para yfinance 0.2.66: Usar apply() en lugar de to_numeric() para evitar bug\n\nInstala primero:\n  pip install yfinance==0.2.38 pandas --upgrade\n\nSi a√∫n hay problemas:\n  pip install yfinance==0.2.38 --force-reinstall\n\"\"\"\n\nimport yfinance as yf\nimport pandas as pd\nfrom datetime import datetime, timedelta\nimport time\nimport sys\nfrom pathlib import Path\nimport warnings\n\n# Silenciar warnings\nwarnings.filterwarnings('ignore')\n\nprint(\"=\"*80)\nprint(\"üì• DESCARGADOR MERVAL - TICKERS CONFIRMADOS\")\nprint(\"=\"*80 + \"\\n\")\n\n# Per√≠odo: √∫ltimos 5 a√±os\nfecha_fin = datetime.now()\nfecha_inicio = fecha_fin - timedelta(days=365*5)\n\nprint(f\"üìÖ Per√≠odo: {fecha_inicio.strftime('%Y-%m-%d')} a {fecha_fin.strftime('%Y-%m-%d')}\\n\")\n\n# SOLO TICKERS QUE FUNCIONAN\nACCIONES_MERVAL = {\n    \"GGAL\": \"Grupo Galicia\",\n    \"BMA\": \"Banco Macro\",\n    \"LOMA\": \"Loma Negra\",\n    \"CEPU\": \"Central Puerto\",\n    \"EDN\": \"Edenor\",\n    \"SUPV\": \"Grupo Supervielle\",\n    \"BBAR\": \"BBVA Argentina\",\n    \"AGRO\": \"Adecoagro\",\n    \"YPFD\": \"YPF\",\n    \"PAMP\": \"Pampa Energ√≠a\",\n    \"ALUA\": \"Aluar\",\n}\n\nprint(f\"‚úÖ Acciones confirmadas: {len(ACCIONES_MERVAL)}\\n\")\n\n# Crear carpetas\nDATA_DIR = Path(\"MERVAL_Datos_Limpio\")\nFUND_DIR = Path(\"MERVAL_Fundamentales\")\nDATA_DIR.mkdir(exist_ok=True)\nFUND_DIR.mkdir(exist_ok=True)\n\nprint(f\"üìÅ Directorio Datos: {DATA_DIR.absolute()}\")\nprint(f\"üìÅ Directorio Fundamentales: {FUND_DIR.absolute()}\\n\")\nprint(\"=\"*80)\nprint(\"DESCARGANDO DATOS HIST√ìRICOS + FUNDAMENTALES\")\nprint(\"=\"*80 + \"\\n\")\n\nresultados = []\nfundamentales_list = []\n\nfor ticker, nombre in ACCIONES_MERVAL.items():\n    print(f\"‚è≥ {ticker:15} ({nombre})\")\n    \n    try:\n        # 1. DESCARGAR DATOS HIST√ìRICOS\n        df_precios = yf.download(\n            ticker,\n            start=fecha_inicio.strftime('%Y-%m-%d'),\n            end=fecha_fin.strftime('%Y-%m-%d'),\n            progress=False,\n            threads=False,\n            auto_adjust=False\n        )\n        \n        if df_precios is None or len(df_precios) == 0:\n            print(f\"   ‚ö†Ô∏è  Sin datos hist√≥ricos\\n\")\n            continue\n        \n        # LIMPIAR CSV\n        df_precios = df_precios.reset_index()\n        \n        if 'Date' in df_precios.columns:\n            df_precios.rename(columns={'Date': 'fecha'}, inplace=True)\n        \n        # Reordenar OHLCV\n        df_precios = df_precios[['fecha', 'Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume']]\n        \n        # FIX para yfinance 0.2.66: Usar apply en lugar de to_numeric\n        # Esto evita el error \"arg must be a list, tuple, 1-d array, or Series\"\n        for col in ['Open', 'High', 'Low', 'Close', 'Adj Close', 'Volume']:\n            df_precios[col] = df_precios[col].apply(lambda x: pd.to_numeric(x, errors='coerce'))\n        \n        # Eliminar NaN\n        df_precios = df_precios.dropna()\n        \n        # Formatear fecha\n        df_precios['fecha'] = pd.to_datetime(df_precios['fecha'])\n        df_precios['fecha'] = df_precios['fecha'].dt.strftime('%Y-%m-%d')\n        \n        if len(df_precios) == 0:\n            print(f\"   ‚ö†Ô∏è  Sin datos despu√©s de limpiar\\n\")\n            continue\n        \n        # Guardar CSV LIMPIO\n        filename_precios = f\"{ticker}_precios_5A.csv\"\n        filepath_precios = DATA_DIR / filename_precios\n        df_precios.to_csv(filepath_precios, index=False, float_format='%.8f')\n        \n        print(f\"   ‚úÖ Datos: {len(df_precios)} registros\")\n        print(f\"   üíæ Guardado: {filename_precios}\")\n        \n        # 2. OBTENER FUNDAMENTALES\n        try:\n            ticker_obj = yf.Ticker(ticker)\n            info = ticker_obj.info\n            \n            fundamentales = {\n                'Ticker': ticker,\n                'Nombre': nombre,\n                'Precio': info.get('currentPrice', 'N/A'),\n                'P/E Ratio (Trailing)': round(info.get('trailingPE', 0), 2) if info.get('trailingPE') else 'N/A',\n                'P/E Ratio (Forward)': round(info.get('forwardPE', 0), 2) if info.get('forwardPE') else 'N/A',\n                'ROE': f\"{round(info.get('returnOnEquity', 0) * 100, 2)}%\" if info.get('returnOnEquity') else 'N/A',\n                'ROA': f\"{round(info.get('returnOnAssets', 0) * 100, 2)}%\" if info.get('returnOnAssets') else 'N/A',\n                'P/B Ratio': round(info.get('priceToBook', 0), 2) if info.get('priceToBook') else 'N/A',\n                'Dividend Yield': f\"{round(info.get('dividendYield', 0) * 100, 2)}%\" if info.get('dividendYield') else 'N/A',\n                'Market Cap': info.get('marketCap', 'N/A'),\n                'Beta': round(info.get('beta', 0), 2) if info.get('beta') else 'N/A',\n                'EPS (Trailing)': round(info.get('trailingEps', 0), 2) if info.get('trailingEps') else 'N/A',\n                'Debt to Equity': round(info.get('debtToEquity', 0), 2) if info.get('debtToEquity') else 'N/A',\n                'Current Ratio': round(info.get('currentRatio', 0), 2) if info.get('currentRatio') else 'N/A',\n                'Quick Ratio': round(info.get('quickRatio', 0), 2) if info.get('quickRatio') else 'N/A',\n            }\n            \n            fundamentales_list.append(fundamentales)\n            print(f\"   üìä P/E: {fundamentales['P/E Ratio (Trailing)']}\")\n            print(f\"   üí≤ Div Yield: {fundamentales['Dividend Yield']}\\n\")\n            \n        except Exception as e:\n            print(f\"   ‚ö†Ô∏è  Fundamentales: {str(e)[:40]}\\n\")\n            fundamentales_list.append({\n                'Ticker': ticker,\n                'Nombre': nombre,\n                'Precio': 'Error',\n                'P/E Ratio (Trailing)': 'Error',\n                'P/E Ratio (Forward)': 'Error',\n                'ROE': 'Error',\n                'ROA': 'Error',\n                'P/B Ratio': 'Error',\n                'Dividend Yield': 'Error',\n                'Market Cap': 'Error',\n                'Beta': 'Error',\n                'EPS (Trailing)': 'Error',\n                'Debt to Equity': 'Error',\n                'Current Ratio': 'Error',\n                'Quick Ratio': 'Error',\n            })\n        \n        resultados.append({\n            'Ticker': ticker,\n            'Nombre': nombre,\n            'Status': '‚úÖ OK',\n            'Datos': len(df_precios),\n            'Archivo': filename_precios\n        })\n        \n        time.sleep(0.5)\n        \n    except Exception as e:\n        print(f\"   ‚ùå Error: {str(e)[:60]}\\n\")\n        resultados.append({\n            'Ticker': ticker,\n            'Nombre': nombre,\n            'Status': '‚ùå Error',\n            'Datos': 0,\n            'Archivo': '-'\n        })\n\n# 3. GUARDAR TABLA DE FUNDAMENTALES\nif fundamentales_list:\n    df_fund = pd.DataFrame(fundamentales_list)\n    filename_fund = \"MERVAL_Fundamentales_Completo.csv\"\n    filepath_fund = FUND_DIR / filename_fund\n    df_fund.to_csv(filepath_fund, index=False)\n    print(f\"üìä Fundamentales guardados: {filename_fund}\\n\")\n\n# 4. RESUMEN FINAL\nprint(\"\\n\" + \"=\"*80)\nprint(\"üìä RESUMEN FINAL\")\nprint(\"=\"*80 + \"\\n\")\n\nif resultados:\n    df_resultados = pd.DataFrame(resultados)\n    print(df_resultados.to_string(index=False))\n    \n    exitosas = len([r for r in resultados if r['Status'] == '‚úÖ OK'])\n    fallidas = len([r for r in resultados if '‚ùå' in r['Status']])\n    \n    print(f\"\\n‚úÖ Exitosas: {exitosas}/{len(ACCIONES_MERVAL)}\")\n    print(f\"‚ùå Fallidas: {fallidas}/{len(ACCIONES_MERVAL)}\")\n\n# 5. LISTAR ARCHIVOS\nprint(f\"\\n{'='*80}\")\nprint(\"üìÅ ARCHIVOS GENERADOS - DATOS\")\nprint(f\"{'='*80}\\n\")\n\nfiles_data = sorted(list(DATA_DIR.glob(\"*.csv\")))\nif files_data:\n    total_size = 0\n    for i, f in enumerate(files_data, 1):\n        size_kb = f.stat().st_size / 1024\n        total_size += size_kb\n        print(f\"{i:2d}. {f.name:30} ({size_kb:8.1f} KB)\")\n    print(f\"\\nüìä Tama√±o total: {total_size:.1f} KB\")\nelse:\n    print(\"No se encontraron archivos de datos\")\n\n# 6. LISTAR FUNDAMENTALES\nprint(f\"\\n{'='*80}\")\nprint(\"üìÅ ARCHIVOS GENERADOS - FUNDAMENTALES\")\nprint(f\"{'='*80}\\n\")\n\nfiles_fund = sorted(list(FUND_DIR.glob(\"*.csv\")))\nif files_fund:\n    for i, f in enumerate(files_fund, 1):\n        size_kb = f.stat().st_size / 1024\n        print(f\"{i:2d}. {f.name:30} ({size_kb:8.1f} KB)\")\nelse:\n    print(\"No se encontraron archivos de fundamentales\")\n\nprint(f\"\\nüìÅ Carpeta Datos: {DATA_DIR.absolute()}\")\nprint(f\"üìÅ Carpeta Fundamentales: {FUND_DIR.absolute()}\\n\")\n\nprint(\"=\"*80)\nprint(\"‚úÖ DESCARGA + AN√ÅLISIS COMPLETADO\")\nprint(\"=\"*80)\nprint(f\"\\nüí° INFORMACI√ìN:\")\nprint(f\"   Per√≠odo: 5 a√±os ({(fecha_fin - fecha_inicio).days} d√≠as)\")\nprint(f\"   yfinance: {yf.__version__}\")\nprint(f\"   pandas: {pd.__version__}\")\nprint(f\"\\n‚úÖ CSVs LIMPIOS - Sin duplicados, sin encabezados extra!\")\nprint(f\"‚úÖ Ratios Fundamentales disponibles para an√°lisis!\")\nprint(f\"‚úÖ {len(ACCIONES_MERVAL)} acciones descargadas!\\n\")\n